{% extends 'base.html' %}

{% block title %}Admin Users{% endblock %}

{% block extra_css %}

{% endblock %}

{% block content %}
<div class="container py-4">
    <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#createUserModal">{{ t('create_user') }}</button>
    <div id="table-container"></div>
</div>

<!-- Create User Modal -->
<div class="modal fade" id="createUserModal" tabindex="-1" aria-labelledby="createUserModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="createUserModalLabel">{{ t('create_user') }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="createUserForm">
          <div class="mb-3">
            <label for="username" class="form-label">{{ t('username') }}</label>
            <input type="text" class="form-control" id="username" name="username" required>
          </div>
          <div class="mb-3">
            <label for="email" class="form-label">{{ t('email') }}</label>
            <input type="email" class="form-control" id="email" name="email" required>
          </div>
          <div class="mb-3">
            <label for="company_id" class="form-label">{{ t('company') }}</label>
            <select class="form-select" id="company_id" name="company_id" required>
              <option value="">{{ t('select_company') }}</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="roles" class="form-label">{{ t('roles') }}</label>
            <select class="form-select" id="roles" name="roles" required>
              <!-- Options will be populated dynamically -->
            </select>
          </div>
          <button type="submit" class="btn btn-success">{{ t('create') }}</button>
        </form>
        <div id="createUserMsg" class="mt-2"></div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
window.TRANSLATIONS = {
    id: "{{ t('id') }}",
    username: "{{ t('username') }}",
    email: "{{ t('email') }}",
    roles: "{{ t('roles') }}",
    company: "{{ t('company') }}",
    select_company: "{{ t('select_company') }}",
    hold_ctrl_select_multiple: "{{ t('hold_ctrl_select_multiple') }}"
};
</script>
<script type="module">
import { paginatedTable } from "{{ url_for('static', filename='js/paginatedTable.js') }}";
paginatedTable({
    endpoint: '/paginate',
    tableName: 'users',
    columns: [
        {key: 'id', label: window.TRANSLATIONS.id},
        {key: 'username', label: window.TRANSLATIONS.username},
        {key: 'email', label: window.TRANSLATIONS.email},
        {key: 'role_name', label: window.TRANSLATIONS.roles},
        {key: 'company_name', label: window.TRANSLATIONS.company}
    ],
    containerId: 'table-container',
    pageSize: 5
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('createUserForm');
    const msgDiv = document.getElementById('createUserMsg');
    const companySelect = document.getElementById('company_id');
    const rolesSelect = document.getElementById('roles');

    // Populate companies and roles when modal is shown
    const modalEl = document.getElementById('createUserModal');
    modalEl.addEventListener('show.bs.modal', async function() {
        // Fetch companies
        try {
            const res = await fetch('/get_companies');
            const companies = await res.json();
            companySelect.innerHTML = `<option value="">${window.TRANSLATIONS.select_company}</option>`;
            companies.forEach(c => {
                companySelect.innerHTML += `<option value="${c.id}">${c.name}</option>`;
            });
        } catch {}
        // Fetch roles
        try {
            const res = await fetch('/get_roles');
            const data = await res.json();
            const roles = data.roles || data;
            rolesSelect.innerHTML = '';
            roles.forEach(r => {
                rolesSelect.innerHTML += `<option value="${r.id}">${r.name}</option>`;
            });
        } catch {}
    });

    if (form) {
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            msgDiv.textContent = '';
            const selectedRoleId = rolesSelect.value;
            const data = {
                username: form.username.value,
                email: form.email.value,
                company_id: companySelect.value || null,
                role_id: selectedRoleId
            };
            try {
                const res = await fetch('/create_user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (res.ok && result.success) {
                    let msg = result.message || 'User created successfully.';
                    if (result.initial_password) {
                        msg += `\nInitial password: ${result.initial_password}`;
                    }
                    msgDiv.textContent = msg;
                    msgDiv.className = 'alert alert-success';
                    form.reset();
                    // Don't auto-close modal so admin can copy password
                } else {
                    msgDiv.textContent = result.message || result.error || 'Error creating user.';
                    msgDiv.className = 'alert alert-danger';
                }
            } catch (err) {
                msgDiv.textContent = 'Server error.';
                msgDiv.className = 'alert alert-danger';
            }
        });
    }
});
</script>
{% endblock %}
