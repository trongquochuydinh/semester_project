{% extends "base.html" %}

{% block title %}Home | Warehouse{% endblock %}

{% block content %}
<div class="row" id="dashboard-row">
  {% if role == 'superadmin' or role == 'admin' %}
    <div id="users-table"></div>
    {% if role == 'superadmin' %}
    <div id="companies-table"></div>
    <div id="stats-container"></div>
    {% endif %}
  {% endif %}
  <div id="income-overview-chart"></div>
  <div id="visitor-chart"></div>
  <div id="visitor-chart-1"></div>
</div>
{% endblock %}

{% block scripts %}
<!-- Page Specific JS -->
<script src="{{ url_for('static', filename='js/plugins/apexcharts.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/elements/card.js') }}"></script>
<script src="{{ url_for('static', filename='js/elements/table.js') }}"></script>
<script src="{{ url_for('static', filename='js/elements/bar-chart.js') }}"></script>
<script src="{{ url_for('static', filename='js/index.js') }}"></script>


<script>
  document.addEventListener("DOMContentLoaded", async () => {
    const container = document.querySelector(".row");

    // Users
    const resUsers = await fetch("/paginate", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ table_name: "users", limit: 5, offset: 0 })
    });
    const users = await resUsers.json();
    container.appendChild(createUsersTableCard({ title: "Users", rows: users.data }));

    // Companies
    const resCompanies = await fetch("/paginate", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ table_name: "companies", limit: 5, offset: 0 })
    });
    const companies = await resCompanies.json();
    container.appendChild(createCompaniesTableCard({ title: "Companies", rows: companies.data }));
  });

async function loadUserStats() {
  const container = document.getElementById("stats-container");
  container.innerHTML = ""; // Clear previous content

  try {
    // ✅ Only one request needed now
    const res = await fetch("/users/get_user_stats");
    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);

    const data = await res.json(); // expected: { total_users: X, online_users: Y }

    // ✅ Create a simple card
    const card = document.createElement("div");
    card.style.border = "1px solid #ccc";
    card.style.borderRadius = "10px";
    card.style.padding = "16px";
    card.style.margin = "8px 0";
    card.style.boxShadow = "0 2px 6px rgba(0,0,0,0.1)";
    card.style.width = "250px";
    card.style.fontFamily = "Arial, sans-serif";

    card.innerHTML = `
      <h3 style="margin: 0 0 8px;">User Statistics</h3>
      <p><b>Total Users:</b> ${data.total_users ?? "N/A"}</p>
      <p><b>Online Users:</b> ${data.online_users ?? "N/A"}</p>
    `;

    container.appendChild(card);
  } catch (err) {
    console.error("Error loading user stats:", err);
    const errorMsg = document.createElement("div");
    errorMsg.textContent = "Failed to load user statistics.";
    errorMsg.style.color = "red";
    container.appendChild(errorMsg);
  }
}

// Run once the page loads
document.addEventListener("DOMContentLoaded", loadUserStats);
</script>
{% endblock %}
